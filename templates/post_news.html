{% extends "base.html" %}

{% block title %}Post News - Yalla Admin{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìù Post News</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" novalidate onsubmit="syncNewsContent()">
                        {{ form.hidden_tag() }}

                        <!-- Title Field -->
                        <div class="mb-4">
                            <label for="title" class="form-label fw-bold">News Title</label>
                            {% if form.title.errors %}
                                {{ form.title(class="form-control is-invalid") }}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.title.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% else %}
                                {{ form.title(class="form-control", placeholder="Enter news title (5-200 characters)") }}
                                <small class="text-muted">Minimum 5 characters, maximum 200 characters</small>
                            {% endif %}
                        </div>

                        <!-- Content Field with Rich Text Editor -->
                        <div class="mb-4">
                            <label for="content" class="form-label fw-bold">üìù News Content (Rich Editor)</label>
                            <div id="editor-toolbar" class="mb-2 quill-toolbar-dark" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                                <!-- Text Formatting -->
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Bold"><strong>B</strong></button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Italic"><em>I</em></button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Underline"><u>U</u></button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Strikethrough">SÃ∂</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Subscript">X‚ÇÇ</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Superscript">X¬≤</button>
                                
                                <div class="btn-group btn-group-sm ms-2" role="group">
                                    <input type="color" class="form-control form-control-sm quill-color" style="width: 40px; height: 38px;" title="Text Color">
                                    <input type="color" class="form-control form-control-sm quill-bg" style="width: 40px; height: 38px;" title="Background Color">
                                </div>
                                
                                <!-- Headers -->
                                <select class="form-select form-select-sm d-inline-block ms-2 quill-header" style="width: 120px;" title="Heading">
                                    <option value="">Normal</option>
                                    <option value="1">Heading 1</option>
                                    <option value="2">Heading 2</option>
                                    <option value="3">Heading 3</option>
                                    <option value="4">Heading 4</option>
                                </select>
                                
                                <!-- Font Size -->
                                <select class="form-select form-select-sm d-inline-block ms-2 quill-size" style="width: 100px;" title="Font Size">
                                    <option value="">Default</option>
                                    <option value="small">Small</option>
                                    <option value="large">Large</option>
                                    <option value="huge">Huge</option>
                                </select>
                                
                                <!-- Lists -->
                                <button type="button" class="btn btn-sm btn-light quill-btn ms-2" title="Unordered List">‚Ä¢ List</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Ordered List">1. List</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Checklist">‚úì Check</button>
                                
                                <!-- Alignment -->
                                <select class="form-select form-select-sm d-inline-block ms-2 quill-align" style="width: 100px;" title="Alignment">
                                    <option value="">Left</option>
                                    <option value="center">Center</option>
                                    <option value="right">Right</option>
                                    <option value="justify">Justify</option>
                                </select>
                                
                                <!-- Special Elements -->
                                <button type="button" class="btn btn-sm btn-light quill-btn ms-2" title="Quote">" Quote</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Code Block">{ } Code</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Insert Link">üîó Link</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Insert Image">üñºÔ∏è Image</button>
                                
                                <!-- Indentation & Others -->
                                <button type="button" class="btn btn-sm btn-light quill-btn ms-2" title="Increase Indent">‚Üí Indent</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Decrease Indent">‚Üê Outdent</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Horizontal Rule">‚Äî‚Äî HR</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Undo">‚Ü∂ Undo</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Redo">‚Ü∑ Redo</button>
                                <button type="button" class="btn btn-sm btn-light quill-btn" title="Clear Formatting">‚úï Clear</button>
                            </div>
                            
                            <div id="editor" class="quill-editor-dark" style="height: 350px; background: white; border: 1px solid #dee2e6; border-radius: 4px;"></div>
                            {{ form.content(id="content", type="hidden") }}
                            {% if form.content.errors %}
                            <div class="text-danger small mt-2">
                                {% for error in form.content.errors %}
                                    {{ error }}<br>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary fw-bold">
                                <span class="me-2">+</span>Post News
                            </button>
                            <a href="{{ url_for('news') }}" class="btn btn-outline-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Box -->
            <div class="alert alert-info mt-4" role="alert">
                <h6 class="alert-heading">üí° Tips for posting news</h6>
                <ul class="mb-0 small">
                    <li>Keep titles clear and concise</li>
                    <li>Use the content area to provide detailed information</li>
                    <li>Proofread before posting</li>
                    <li>News posts will be visible to all users immediately</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
/* Dark Mode Styles for Quill Editor */
body.dark-mode #editor-toolbar {
    background: #2a2a2a !important;
    border-color: #444 !important;
}

body.dark-mode #editor-toolbar .quill-btn,
body.dark-mode #editor-toolbar .form-select,
body.dark-mode #editor-toolbar .form-control,
body.dark-mode #editor-toolbar input[type="color"] {
    background-color: #3a3a3a !important;
    border-color: #555 !important;
    color: #e0e0e0 !important;
}

body.dark-mode #editor-toolbar .quill-btn:hover,
body.dark-mode #editor-toolbar .form-select:hover {
    background-color: #4a4a4a !important;
}

body.dark-mode .quill-editor-dark {
    background: #1e1e1e !important;
    border-color: #444 !important;
}

body.dark-mode .quill-editor-dark .ql-editor {
    background: #1e1e1e !important;
    color: #e0e0e0 !important;
}

body.dark-mode .quill-editor-dark .ql-editor.ql-blank::before {
    color: #888 !important;
}

body.dark-mode .quill-editor-dark .ql-toolbar {
    background: transparent !important;
    border: none !important;
}

body.dark-mode .quill-editor-dark .ql-container {
    border: none !important;
}

/* Light mode defaults */
#editor-toolbar {
    transition: background-color 0.3s, border-color 0.3s;
}

#editor-toolbar .quill-btn,
#editor-toolbar .form-select {
    transition: background-color 0.2s;
}

.quill-editor-dark .ql-editor {
    font-size: 16px;
    line-height: 1.6;
}

.quill-editor-dark .ql-editor h1, 
.quill-editor-dark .ql-editor h2, 
.quill-editor-dark .ql-editor h3 {
    margin-bottom: 0.5rem;
}

/* Hide default Quill toolbar - we use custom toolbar */
.ql-toolbar {
    display: none !important;
}

/* Hide the form content field - data is synced via Quill */
#content {
    display: none !important;
}
</style>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
var quill = null;

function syncNewsContent() {
    if (quill) {
        var contentField = document.getElementById('content');
        if (contentField) {
            contentField.value = quill.root.innerHTML;
            console.log('Content synced on form submit');
        }
    }
    return true;
}

try {
    document.addEventListener('DOMContentLoaded', function() {
        quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'Write your news content here...',
            modules: {
                toolbar: false,
                history: {delay: 1000, maxStack: 50, userOnly: true}
            }
        });

        // Formatting buttons
        var boldBtn = document.querySelector('.quill-btn[title="Bold"]');
        if (boldBtn) boldBtn.addEventListener('click', function(e) { e.preventDefault(); quill.format('bold', !quill.getFormat().bold); quill.focus(); });

        var italicBtn = document.querySelector('.quill-btn[title="Italic"]');
        if (italicBtn) italicBtn.addEventListener('click', function(e) { e.preventDefault(); quill.format('italic', !quill.getFormat().italic); quill.focus(); });

        var underlineBtn = document.querySelector('.quill-btn[title="Underline"]');
        if (underlineBtn) underlineBtn.addEventListener('click', function(e) { e.preventDefault(); quill.format('underline', !quill.getFormat().underline); quill.focus(); });

        var strikeBtn = document.querySelector('.quill-btn[title="Strikethrough"]');
        if (strikeBtn) strikeBtn.addEventListener('click', function(e) { e.preventDefault(); quill.format('strike', !quill.getFormat().strike); quill.focus(); });

        // Color pickers
        var colorPicker = document.querySelector('.quill-color');
        if (colorPicker) colorPicker.addEventListener('change', function() { quill.format('color', this.value); quill.focus(); });

        var bgPicker = document.querySelector('.quill-bg');
        if (bgPicker) bgPicker.addEventListener('change', function() { quill.format('background', this.value); quill.focus(); });

        // Selects
        var headerSelect = document.querySelector('.quill-header');
        if (headerSelect) headerSelect.addEventListener('change', function() { quill.format('header', this.value ? parseInt(this.value) : false); quill.focus(); });

        var sizeSelect = document.querySelector('.quill-size');
        if (sizeSelect) sizeSelect.addEventListener('change', function() { quill.format('size', this.value || false); quill.focus(); });

        var alignSelect = document.querySelector('.quill-align');
        if (alignSelect) alignSelect.addEventListener('change', function() { quill.format('align', this.value || false); quill.focus(); });

        // List buttons
        var ulBtn = document.querySelector('.quill-btn[title="Unordered List"]');
        if (ulBtn) ulBtn.addEventListener('click', function(e) { e.preventDefault(); quill.format('list', quill.getFormat().list === 'bullet' ? false : 'bullet'); quill.focus(); });

        var olBtn = document.querySelector('.quill-btn[title="Ordered List"]');
        if (olBtn) olBtn.addEventListener('click', function(e) { e.preventDefault(); quill.format('list', quill.getFormat().list === 'ordered' ? false : 'ordered'); quill.focus(); });

        // Special formatting
        var quoteBtn = document.querySelector('.quill-btn[title="Quote"]');
        if (quoteBtn) quoteBtn.addEventListener('click', function(e) { e.preventDefault(); quill.format('blockquote', !quill.getFormat().blockquote); quill.focus(); });

        var codeBtn = document.querySelector('.quill-btn[title="Code Block"]');
        if (codeBtn) codeBtn.addEventListener('click', function(e) { e.preventDefault(); quill.format('code-block', !quill.getFormat()['code-block']); quill.focus(); });

        // Link & Image
        var linkBtn = document.querySelector('.quill-btn[title="Insert Link"]');
        if (linkBtn) linkBtn.addEventListener('click', function(e) { e.preventDefault(); var url = prompt('Enter URL:'); if (url) { quill.format('link', url); quill.focus(); } });

        var imgBtn = document.querySelector('.quill-btn[title="Insert Image"]');
        if (imgBtn) imgBtn.addEventListener('click', function(e) { e.preventDefault(); var url = prompt('Enter image URL:'); if (url) { quill.insertEmbed(quill.getLength() - 1, 'image', url); quill.focus(); } });

        // Undo/Redo
        var undoBtn = document.querySelector('.quill-btn[title="Undo"]');
        if (undoBtn) undoBtn.addEventListener('click', function(e) { e.preventDefault(); quill.history.undo(); quill.focus(); });

        var redoBtn = document.querySelector('.quill-btn[title="Redo"]');
        if (redoBtn) redoBtn.addEventListener('click', function(e) { e.preventDefault(); quill.history.redo(); quill.focus(); });

        // Form sync - also handles the onsubmit
        syncNewsContent();

        // Load existing content
        var contentField = document.getElementById('content');
        if (contentField && contentField.value) {
            quill.root.innerHTML = contentField.value;
        }

        // Dark mode
        var appBody = document.getElementById('appBody');
        if (appBody && appBody.classList.contains('dark-mode')) {
            var toolbar = document.getElementById('editor-toolbar');
            var editor = document.getElementById('editor');
            if (toolbar) toolbar.style.background = '#2a2a2a';
            if (editor) {
                var editorContent = editor.querySelector('.ql-editor');
                if (editorContent) {
                    editorContent.style.background = '#1e1e1e';
                    editorContent.style.color = '#e0e0e0';
                }
            }
        }
    });
} catch(err) {
    console.error('News editor error:', err);
}
</script>
{% endblock %}
