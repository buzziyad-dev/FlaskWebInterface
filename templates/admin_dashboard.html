{% extends "base.html" %}

{% block content %}
<style>
/* Dark mode styles for admin dashboard */
body.dark-mode .bg-primary {
    background-color: #1a3a52 !important;
}

body.dark-mode .modal-content {
    background-color: #2a2a2a !important;
    color: #e0e0e0 !important;
}

body.dark-mode .modal-header {
    background-color: #3a3a3a !important;
    border-bottom-color: #555 !important;
}

body.dark-mode .modal-body,
body.dark-mode .modal-footer {
    border-color: #555 !important;
}

body.dark-mode .modal-body {
    color: #e0e0e0 !important;
}

body.dark-mode .form-control,
body.dark-mode .form-select {
    background-color: #3a3a3a !important;
    color: #e0e0e0 !important;
    border-color: #555 !important;
}

body.dark-mode .form-control:focus,
body.dark-mode .form-select:focus {
    background-color: #3a3a3a !important;
    color: #e0e0e0 !important;
    border-color: #6c63ff !important;
    box-shadow: 0 0 0 0.2rem rgba(108, 99, 255, 0.25) !important;
}

body.dark-mode .table {
    color: #e0e0e0 !important;
    border-color: #555 !important;
}

body.dark-mode .table thead {
    border-bottom-color: #555 !important;
}

body.dark-mode .table tbody tr {
    border-bottom-color: #555 !important;
}

body.dark-mode .table tbody tr:hover {
    background-color: #3a3a3a !important;
}

body.dark-mode .card {
    background-color: #2a2a2a !important;
    color: #e0e0e0 !important;
    border-color: #555 !important;
}

body.dark-mode .card-header {
    background-color: #3a3a3a !important;
    border-bottom-color: #555 !important;
}

body.dark-mode .btn-outline-primary {
    color: #6c63ff !important;
    border-color: #6c63ff !important;
}

body.dark-mode .btn-outline-primary:hover {
    background-color: #6c63ff !important;
    border-color: #6c63ff !important;
    color: white !important;
}

body.dark-mode .nav-tabs {
    border-bottom-color: #555 !important;
}

body.dark-mode .nav-tabs .nav-link {
    color: #a0a0a0 !important;
}

body.dark-mode .nav-tabs .nav-link.active {
    background-color: #2a2a2a !important;
    color: #e0e0e0 !important;
    border-color: #555 #555 #2a2a2a !important;
}

body.dark-mode .badge {
    background-color: #3a3a3a !important;
    color: #e0e0e0 !important;
}

body.dark-mode .alert {
    background-color: #3a3a3a !important;
    color: #e0e0e0 !important;
    border-color: #555 !important;
}

body.dark-mode .text-muted {
    color: #a0a0a0 !important;
}

body.dark-mode .form-check-input {
    background-color: #3a3a3a !important;
    border-color: #555 !important;
}

body.dark-mode .form-check-input:checked {
    background-color: #6c63ff !important;
    border-color: #6c63ff !important;
}

body.dark-mode .form-switch .form-check-input:checked {
    background-color: #6c63ff !important;
}

body.dark-mode .spinner-border {
    color: #6c63ff !important;
}

body.dark-mode input[type="color"] {
    background-color: #3a3a3a !important;
    border-color: #555 !important;
}

body.dark-mode textarea {
    background-color: #3a3a3a !important;
    color: #e0e0e0 !important;
    border-color: #555 !important;
}

body.dark-mode .container {
    color: #e0e0e0 !important;
}

body.dark-mode label {
    color: #e0e0e0 !important;
}

body.dark-mode .form-label {
    color: #e0e0e0 !important;
}

body.dark-mode small {
    color: #c0c0c0 !important;
}

body.dark-mode .text-secondary {
    color: #b0b0b0 !important;
}

body.dark-mode .text-dark {
    color: #e0e0e0 !important;
}

body.dark-mode h1, 
body.dark-mode h2, 
body.dark-mode h3, 
body.dark-mode h4, 
body.dark-mode h5, 
body.dark-mode h6 {
    color: #e0e0e0 !important;
}

body.dark-mode p {
    color: #e0e0e0 !important;
}

body.dark-mode div, 
body.dark-mode span {
    color: #e0e0e0 !important;
}

body.dark-mode .form-control::placeholder {
    color: #808080 !important;
}

body.dark-mode .form-select {
    color: #e0e0e0 !important;
}

body.dark-mode .form-check-label {
    color: #e0e0e0 !important;
}

body.dark-mode .btn-primary {
    background-color: #6c63ff !important;
    border-color: #6c63ff !important;
}

body.dark-mode .btn-secondary {
    background-color: #3a3a3a !important;
    border-color: #555 !important;
    color: #e0e0e0 !important;
}

body.dark-mode .btn-danger {
    background-color: #d32f2f !important;
    border-color: #d32f2f !important;
}

body.dark-mode .btn-success {
    background-color: #388e3c !important;
    border-color: #388e3c !important;
}

body.dark-mode .btn {
    color: #fff !important;
}

body.dark-mode th {
    background-color: #3a3a3a !important;
    color: #e0e0e0 !important;
    border-color: #555 !important;
}

body.dark-mode td {
    color: #e0e0e0 !important;
    border-color: #555 !important;
}

body.dark-mode a {
    color: #6c63ff !important;
}

body.dark-mode a:hover {
    color: #8b7aff !important;
}
</style>

<!-- CSRF Token for AJAX -->
<meta name="csrf-token" content="{{ csrf_token() }}">
<div class="bg-primary text-white py-4">
    <div class="container d-flex justify-content-between align-items-center">
        <h2 class="fw-bold mb-0">üîß Admin Control Panel</h2>
        <div>
            <small class="text-white-50">Auto-refreshing every 5 seconds</small>
            <div class="form-check form-switch d-inline-block ms-3">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                <label class="form-check-label text-white-50" for="autoRefreshToggle">
                    Auto-Refresh
                </label>
            </div>
        </div>
    </div>
</div>

<div class="container py-5">
    <!-- Submission Details Modal -->
    <div class="modal fade" id="submissionDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Restaurant Submission Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="submissionDetailsContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ban User Modal -->
    <div class="modal fade" id="banUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ban User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" id="banUserForm" action="{{ url_for('manage_user', id=0) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="ban">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="banReason" class="form-label">Username</label>
                            <input type="text" class="form-control" id="banUsername" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="banReason" class="form-label">Ban Reason</label>
                            <textarea class="form-control" id="banReason" name="ban_reason" rows="4" placeholder="Enter the reason for banning this user..." required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Ban User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" id="editUserForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="edit">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                        </div>
                        <hr>
                        <h6 class="fw-bold mb-3">Change Credentials</h6>
                        <div class="mb-3">
                            <label class="form-label">New Password (leave blank to keep current)</label>
                            <input type="password" class="form-control" id="editPassword" name="new_password" placeholder="Min 8 characters">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Username (leave blank to keep current)</label>
                            <input type="text" class="form-control" id="editNewUsername" name="change_to_username" placeholder="New username (3-64 chars)">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Badge Modal -->
    <div class="modal fade" id="createBadgeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Badge</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('create_badge') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Badge Name</label>
                            <input type="text" class="form-control" name="badge_name" placeholder="e.g., Verified Reviewer" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Badge Color</label>
                            <div class="d-flex gap-2">
                                <input type="color" class="form-control" id="badgeColorPicker" name="badge_color" value="#007bff" style="max-width: 80px;">
                                <input type="text" class="form-control" id="badgeColorValue" value="#007bff" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="badge_description" placeholder="Optional description..." rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Badge</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Receipt Modal -->
    <div class="modal fade" id="viewReceiptModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üì∏ Review Receipt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="receiptImagePreview" src="" style="max-width: 100%; max-height: 500px; border-radius: 8px;" alt="Receipt">
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Badges Modal -->
    <div class="modal fade" id="assignBadgesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Badges to User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 id="assignBadgesUsername" class="fw-bold mb-3"></h6>
                    <div id="badgesList" class="d-flex flex-wrap gap-2">
                        <!-- Badges will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Cuisine Modal -->
    <div class="modal fade" id="editCuisineModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Cuisine</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" id="editCuisineForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Cuisine Name</label>
                            <input type="text" class="form-control" id="editCuisineName" name="name" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Restaurant Modal -->
    <div class="modal fade" id="editRestaurantModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Restaurant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" id="editRestaurantForm" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" id="editRestaurantName" name="name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cuisine</label>
                                <select class="form-select" id="editRestaurantCuisine" name="cuisine_id" required>
                                    <option value="">Select Cuisine</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="editRestaurantDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hours</label>
                                <input type="text" class="form-control" id="editRestaurantHours" name="working_hours">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Price Range</label>
                                <select class="form-select" id="editRestaurantPrice" name="price_range" required>
                                    <option value="1">$</option>
                                    <option value="2">$$</option>
                                    <option value="3">$$$</option>
                                    <option value="4">$$$$</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-control" id="editRestaurantAddress" name="address" placeholder="e.g., King Fahd Road, Jeddah">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" id="editRestaurantPhone" name="phone" placeholder="e.g., +966 12 123 4567">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Location Latitude</label>
                                <input type="number" step="0.000001" class="form-control" id="editLocationLatitude" name="location_latitude" placeholder="e.g., 21.5433">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Location Longitude</label>
                                <input type="number" step="0.000001" class="form-control" id="editLocationLongitude" name="location_longitude" placeholder="e.g., 39.1728">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Food Categories (comma-separated)</label>
                            <textarea class="form-control" id="editFoodCategories" name="food_categories" placeholder="e.g., Appetizers, Main Courses, Desserts" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Restaurant Image</label>
                            <input type="file" class="form-control" id="editRestaurantImage" name="restaurant_image" accept=".png,.jpg,.jpeg">
                            <small class="text-muted">PNG or JPG only</small>
                        </div>
                        <div class="mb-3">
                            <div id="editImagePreview"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="editSmallBiz" name="is_small_business">
                                    <label class="form-check-label">Small Business</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="editApproved" name="is_approved">
                                    <label class="form-check-label">Approved</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="editPromoted" name="is_promoted">
                                    <label class="form-check-label">Featured/Promoted</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Badge Modal -->
    <div class="modal fade" id="editBadgeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" id="editBadgeForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Badge</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Badge Name</label>
                            <input type="text" class="form-control" name="badge_name" id="editBadgeName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Badge Color</label>
                            <input type="color" class="form-control" name="badge_color" id="editBadgeColor" value="#007bff" style="max-width:80px;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="badge_description" id="editBadgeDescription" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" role="tablist" id="adminTabs">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-tab="overview" type="button" role="tab">
                üìä Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="restaurants-tab" data-tab="restaurants" type="button" role="tab">
                üçΩÔ∏è Restaurants
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-tab="users" type="button" role="tab">
                üë• Users
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reviews-tab" data-tab="reviews" type="button" role="tab">
                ‚≠ê Reviews
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cuisines-tab" data-tab="cuisines" type="button" role="tab">
                üç¥ Cuisines
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="news-tab" data-tab="news" type="button" role="tab">
                üì∞ News
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="badges-tab" data-tab="badges" type="button" role="tab">
                üéñÔ∏è Badges
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-tab="settings" type="button" role="tab">
                ‚öôÔ∏è Settings
            </button>
        </li>
    </ul>

    <!-- Tab Content Container -->
    <div id="tabContent"></div>
</div>

{% set news_tab_html %}
<div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white">
        <h4 class="mb-0 fw-bold">üì∞ News Management</h4>
    </div>
    <div class="card-body px-4 py-4">
        <div class="row mb-3">
            <div class="col-md-6 mb-2">
                <h6 class="fw-bold mb-3">Quick Actions</h6>
                <a href="{{ url_for('post_news') }}" class="btn btn-primary btn-sm me-2 mb-2">
                    <span class="me-2">+</span>Post New Article
                </a>
                <a href="{{ url_for('news') }}" class="btn btn-outline-primary btn-sm mb-2">
                    üëÅÔ∏è View All News
                </a>
            </div>
        </div>
        <hr>
        <div class="mb-3">
            <p class="text-muted small mb-2">
                Use the News tab to share important updates with your community. News posts are published immediately and visible to all users on the News page.
            </p>
            <div class="alert alert-info small mb-0">
                <strong>üí° Tip:</strong> Use news posts to announce new restaurants, community events, special promotions, or important platform updates.
            </div>
        </div>
    </div>
</div>
{% endset %}

{% set settings_tab_html %}
<div class="card shadow-sm mb-4">
    <div class="card-header bg-warning text-dark">
        <h4 class="mb-0 fw-bold">‚öôÔ∏è Admin Settings</h4>
    </div>
    <div class="card-body px-4 py-4">
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="fw-bold mb-3">Change User Password</h6>
                <form method="POST" action="{{ url_for('admin_change_password') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-2">
                        <label class="form-label small">Username</label>
                        <input type="text" name="username" class="form-control form-control-sm" placeholder="Enter username" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">New Password</label>
                        <input type="password" name="new_password" class="form-control form-control-sm" placeholder="Min 8 characters" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Confirm Password</label>
                        <input type="password" name="confirm_password" class="form-control form-control-sm" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">Update Password</button>
                </form>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold mb-3">Change Username</h6>
                <form method="POST" action="{{ url_for('admin_change_username') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-2">
                        <label class="form-label small">Current Username</label>
                        <input type="text" name="current_username" class="form-control form-control-sm" placeholder="Enter current username" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">New Username</label>
                        <input type="text" name="new_username" class="form-control form-control-sm" placeholder="New username (3-64 chars)" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">Update Username</button>
                </form>
            </div>
        </div>
        <hr>
        <h6 class="fw-bold mb-3">Feature Toggles</h6>
        <div class="row" id="featureToggles">
            <p class="text-muted small">Loading toggles...</p>
        </div>
    </div>
</div>
{% endset %}

<script>
/* Admin dashboard client logic ‚Äî robust renderer + event wiring
   - Fetches admin data from /admin/api/data
   - Renders tabs (overview, restaurants, users, reviews, cuisines, news, badges, settings)
   - Ensures dynamic links/actions use actual IDs (avoids /0)
   - attachEventListeners is defined before use
*/

let adminData = null;
let currentTab = '{{ tab }}' || 'overview';
let autoRefreshEnabled = true;
let refreshInterval = null;
let checkboxStates = {}; // Store checkbox states

// Save current checkbox states before re-rendering
function saveCheckboxStates() {
    checkboxStates = {};
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (cb.className.includes('checkbox') && !cb.id.includes('autoRefresh') && !cb.id.includes('SelectAll') && !cb.id.includes('badgeCheckbox')) {
            checkboxStates[cb.value] = cb.checked;
        }
    });
}

// Restore checkbox states after re-rendering
function restoreCheckboxStates() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (cb.className.includes('checkbox') && checkboxStates.hasOwnProperty(cb.value)) {
            cb.checked = checkboxStates[cb.value];
        }
    });
}

// Load admin data from API
async function loadAdminData() {
    try {
        saveCheckboxStates();
        const res = await fetch('{{ url_for("admin_api_data") }}', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('Failed to load admin data');
        adminData = await res.json();
        renderTab(currentTab);
        // Restore states after a small delay to ensure rendering is complete
        setTimeout(restoreCheckboxStates, 0);
    } catch (err) {
        console.error('loadAdminData error:', err);
    }
}

// Attach event listeners for dynamic elements; must be available before usage
function attachEventListeners() {
    // Replace '/0' placeholders on forms that contain data-id
    document.querySelectorAll('form[data-id]').forEach(form => {
        const id = form.dataset.id;
        // On submit ensure action has proper id
        form.addEventListener('submit', function(e) {
            if (!this.action) return;
            if (this.action.includes('/0')) {
                this.action = this.action.replace(/\/0(\/|$)/, `/${id}$1`);
            }
        });
    });

    // Update anchor links used for restaurant/profile routing
    document.querySelectorAll('a[data-restaurant-id]').forEach(a => {
        a.href = `/restaurant/${a.dataset.restaurantId}`;
    });
    document.querySelectorAll('a[data-user-id]').forEach(a => {
        a.href = `/profile/${a.dataset.userId}`;
    });

    // Edit user modal wiring
    document.querySelectorAll('.edit-user-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const email = this.dataset.email;
            const reputation = this.dataset.reputation;
            const form = document.getElementById('editUserForm');
            if (form) form.action = `{{ url_for('manage_user', id=0) }}`.replace('/0', `/${id}`);
            const uName = document.getElementById('editUsername');
            const uEmail = document.getElementById('editEmail');
        });
    });

    // Ban user modal wiring
    document.querySelectorAll('.ban-user-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const banForm = document.getElementById('banUserForm');
            const banUsername = document.getElementById('banUsername');
            const banReason = document.getElementById('banReason');
            if (banUsername) banUsername.value = username || '';
            if (banReason) banReason.value = '';
            if (banForm) banForm.action = `{{ url_for('manage_user', id=0) }}`.replace('/0', `/${id}`);
        });
    });

    // Edit cuisine wiring
    document.querySelectorAll('.edit-cuisine-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const name = this.dataset.name;
            const form = document.getElementById('editCuisineForm');
            if (form) form.action = `{{ url_for('edit_cuisine', id=0) }}`.replace('/0', `/${id}`);
            const input = document.getElementById('editCuisineName');
            if (input) input.value = name || '';
        });
    });

    // Edit badge wiring
    document.querySelectorAll('.edit-badge-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const name = this.dataset.name || '';
            const color = this.dataset.color || '#007bff';
            const desc = this.dataset.description || '';
            const form = document.getElementById('editBadgeForm');
            if (form) form.action = `{{ url_for('edit_badge', id=0) }}`.replace('/0', `/${id}`);
            const n = document.getElementById('editBadgeName');
            const c = document.getElementById('editBadgeColor');
            const d = document.getElementById('editBadgeDescription');
            if (n) n.value = name;
            if (c) c.value = color;
            if (d) d.value = desc;
        });
    });

    // Hierarchy save button wiring
    document.querySelectorAll('.hierarchy-save-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const badgeId = this.dataset.badgeId;
            const input = this.parentElement.querySelector('.hierarchy-input');
            const hierarchy = input.value;
            const formData = new FormData();
            formData.append('hierarchy', hierarchy);
            try {
                const res = await fetch(`{{ url_for('update_badge_hierarchy', badge_id=0) }}`.replace('/0', `/${badgeId}`), {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '' },
                    credentials: 'same-origin'
                });
                if (res.ok) {
                    alert('Hierarchy updated!');
                    loadAdminData();
                } else {
                    alert('Error updating hierarchy');
                }
            } catch(err) {
                console.error('Error:', err);
                alert('Error: ' + err.message);
            }
        });
    });

    // Edit restaurant wiring (populate fields)
    document.querySelectorAll('.edit-restaurant-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const rest = (adminData && adminData.approved || []).find(r => r.id === Number(id));
            if (!rest) return;
            const form = document.getElementById('editRestaurantForm');
            if (form) form.action = `{{ url_for('edit_restaurant', id=0) }}`.replace('/0', `/${id}`);
            const name = document.getElementById('editRestaurantName');
            const desc = document.getElementById('editRestaurantDescription');
            const address = document.getElementById('editRestaurantAddress');
            const phone = document.getElementById('editRestaurantPhone');
            const hours = document.getElementById('editRestaurantHours');
            const price = document.getElementById('editRestaurantPrice');
            const cuisineSelect = document.getElementById('editRestaurantCuisine');
            const smallBiz = document.getElementById('editSmallBiz');
            const approved = document.getElementById('editApproved');
            const promoted = document.getElementById('editPromoted');
            const categories = document.getElementById('editFoodCategories');
            const preview = document.getElementById('editImagePreview');
            const latField = document.getElementById('editLocationLatitude');
            const lonField = document.getElementById('editLocationLongitude');
            if (name) name.value = rest.name || '';
            if (desc) desc.value = rest.description || '';
            if (address) address.value = rest.address || '';
            if (phone) phone.value = rest.phone || '';
            if (hours) hours.value = rest.working_hours || '';
            if (price) price.value = rest.price_range || 1;
            if (smallBiz) smallBiz.checked = !!rest.is_small_business;
            if (approved) approved.checked = !!rest.is_approved;
            if (promoted) promoted.checked = !!rest.is_promoted;
            if (latField) latField.value = rest.location_latitude || '';
            if (lonField) lonField.value = rest.location_longitude || '';
            if (categories) categories.value = (rest.food_categories || []).join(', ');
            if (preview) {
                preview.innerHTML = rest.image_url ? `<img src="${rest.image_url}" style="max-width:200px; max-height:150px; border-radius:4px;">` : '<p class="text-muted small">No image</p>';
            }
            // ensure cuisine options exist
            if (cuisineSelect && adminData.all_cuisines) {
                adminData.all_cuisines.forEach(c => {
                    if (!cuisineSelect.querySelector(`option[value="${c.id}"]`)) {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name;
                        cuisineSelect.appendChild(opt);
                    }
                });
                cuisineSelect.value = rest.cuisine_id || '';
            }
        });
    });

    // Toggle feature buttons (settings tab)
    document.querySelectorAll('.feature-toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const feature = this.dataset.feature;
            toggleFeature(feature);
        });
    });

    // Bulk delete handlers for restaurant/user/cuisine
    ['restaurant', 'user', 'cuisine'].forEach(type => {
        const selectAll = document.getElementById(`${type}SelectAll`);
        const bulkBtn  = document.getElementById(`${type}BulkDelete`);
        if (!selectAll || !bulkBtn) return;
        const selector = {
            restaurant: '.restaurant-checkbox',
            user: '.user-checkbox',
            cuisine: '.cuisine-checkbox'
        }[type];
        const checkboxes = document.querySelectorAll(selector);
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
            bulkBtn.style.display = document.querySelectorAll(`${selector}:checked`).length > 0 ? '' : 'none';
        });
        checkboxes.forEach(cb => cb.addEventListener('change', () => {
            bulkBtn.style.display = document.querySelectorAll(`${selector}:checked`).length > 0 ? '' : 'none';
        }));
        bulkBtn.addEventListener('click', function() {
            const ids = Array.from(document.querySelectorAll(`${selector}:checked`)).map(cb => cb.value);
            if (ids.length === 0) return;
            if (!confirm(`Delete ${ids.length} ${type}(s)?`)) return;
            const f = document.createElement('form');
            f.method = 'POST';
            f.action = '{{ url_for("bulk_delete") }}';
            f.innerHTML = `<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><input type="hidden" name="type" value="${type}">` + ids.map(i => `<input type="hidden" name="ids[]" value="${i}">`).join('');
            document.body.appendChild(f);
            f.submit();
        });
    });

    // File preview for edit image input
    const editImg = document.getElementById('editRestaurantImage');
    if (editImg) {
        editImg.addEventListener('change', function() {
            const preview = document.getElementById('editImagePreview');
            const file = this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => { if (preview) preview.innerHTML = `<img src="${e.target.result}" style="max-width:200px; max-height:150px; border-radius:4px;">`; };
            reader.readAsDataURL(file);
        });
    }

    // View receipt image button click
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('view-receipt-btn')) {
            const receipt = e.target.dataset.receipt;
            const previewImg = document.getElementById('receiptImagePreview');
            if (previewImg && receipt) {
                previewImg.src = receipt;
            }
        }
    });

    // Delegate assign badges button clicks and properly handle modal
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('assign-badges-btn')) {
            const userId = e.target.dataset.id;
            const username = e.target.dataset.username;
            const usernameDisplay = document.getElementById('assignBadgesUsername');
            if (usernameDisplay) usernameDisplay.textContent = `Assign badges to: ${username}`;
            
            fetch(`/admin/api/user-badges/${userId}`, { credentials: 'same-origin' })
                .then(r => r.json())
                .then(userData => {
                    const badgesContainer = document.getElementById('badgesList');
                    const allBadges = adminData?.all_badges || [];
                    const userBadgeIds = (userData.custom_badges || []).map(b => b.id);
                    
                    badgesContainer.innerHTML = allBadges.map(b => {
                        const assigned = userBadgeIds.includes(b.id);
                        return `
                            <button type="button" class="btn btn-sm badge-toggle-btn" 
                                    data-user-id="${userId}"
                                    data-badge-id="${b.id}"
                                    data-assigned="${assigned}"
                                    style="background:${b.color};color:#fff;opacity:${assigned?1:0.5};border:none;cursor:pointer;"
                                    title="${b.description || b.name}">
                                ${b.name}${assigned?' ‚úì':''}
                            </button>
                        `;
                    }).join('');
                    
                    // Wire badge toggle buttons
                    document.querySelectorAll('.badge-toggle-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const uid = this.dataset.userId;
                            const bid = this.dataset.badgeId;
                            const assigned = this.dataset.assigned === 'true';
                            toggleUserBadge(Number(uid), Number(bid), !assigned, this);
                        });
                    });
                })
                .catch(err => console.error('Error fetching badges:', err));
        }
    });

    async function toggleUserBadge(userId, badgeId, assign, btnElement) {
        try {
            const route = assign ? 'assign_badge' : 'remove_badge';
            const url = `{{ url_for('assign_badge', user_id=0, badge_id=0) }}`.replace('/0/0', `/${userId}/${badgeId}`);
            if (route === 'remove_badge') {
                const url2 = `{{ url_for('remove_badge', user_id=0, badge_id=0) }}`.replace('/0/0', `/${userId}/${badgeId}`);
            }
            
            const endpoint = assign ? 
                `{{ url_for('assign_badge', user_id=0, badge_id=0) }}`.replace('/0/0', `/${userId}/${badgeId}`) :
                `{{ url_for('remove_badge', user_id=0, badge_id=0) }}`.replace('/0/0', `/${userId}/${badgeId}`);
            
            const res = await fetch(endpoint, { 
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '' },
                credentials: 'same-origin'
            });
            const data = await res.json();
            
            if (res.ok && data.success) {
                if (btnElement) {
                    btnElement.dataset.assigned = assign;
                    btnElement.style.opacity = assign ? '1' : '0.5';
                    btnElement.textContent = btnElement.textContent.replace(' ‚úì', '') + (assign ? ' ‚úì' : '');
                }
            } else {
                alert('Error: ' + (data.error || 'Failed to toggle badge'));
            }
        } catch (err) {
            console.error('Error toggling badge:', err);
            alert('Error: ' + err.message);
        }
    }
}

// Tab renderers return HTML strings; keep them simple and consistent
function renderTab(tab) {
    currentTab = tab;
    document.querySelectorAll('#adminTabs button').forEach(b => b.classList.remove('active'));
    const activeBtn = document.getElementById(`${tab}-tab`);
    if (activeBtn) activeBtn.classList.add('active');
    const container = document.getElementById('tabContent');
    let html = '';
    switch(tab) {
        case 'overview': html = renderOverviewTab(); break;
        case 'restaurants': html = renderRestaurantsTab(); break;
        case 'users': html = renderUsersTab(); break;
        case 'reviews': html = renderReviewsTab(); break;
        case 'cuisines': html = renderCuisinesTab(); break;
        case 'news': html = renderNewsTab(); break;
        case 'badges': html = renderBadgesTab(); break;
        case 'settings': html = renderSettingsTab(); break;
        default: html = renderOverviewTab();
    }
    container.innerHTML = html;
    attachEventListeners();
}

// Minimal render functions (overview/restaurants shown as examples; others to use adminData similarly)
function renderOverviewTab() {
    return `
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center shadow-sm"><div class="card-body"><h3 class="fw-bold text-primary mb-0">${adminData.pending.length}</h3><p class="text-muted small mb-0">Pending Approvals</p></div></div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm"><div class="card-body"><h3 class="fw-bold text-success mb-0">${adminData.approved.length}</h3><p class="text-muted small mb-0">Approved Restaurants</p></div></div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm"><div class="card-body"><h3 class="fw-bold text-info mb-0">${adminData.total_users}</h3><p class="text-muted small mb-0">Total Users</p></div></div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm"><div class="card-body"><h3 class="fw-bold text-warning mb-0">${adminData.total_reviews}</h3><p class="text-muted small mb-0">Total Reviews</p></div></div>
        </div>
    </div>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark"><h4 class="mb-0 fw-bold">‚ö†Ô∏è Pending Restaurant Submissions</h4></div>
        <div class="card-body">
            ${adminData.pending.length ? `
            <div class="table-responsive"><table class="table table-hover"><thead><tr><th>Restaurant Name</th><th>Cuisine</th><th>Submitted</th><th>Actions</th></tr></thead><tbody>
                ${adminData.pending.map(r => `
                <tr>
                    <td><strong>${r.name}</strong><br><small class="text-muted">${r.description}</small></td>
                    <td>${r.cuisine}</td>
                    <td>${r.created_at}</td>
                    <td>
                        <button class="btn btn-info btn-sm view-details-btn" data-id="${r.id}" onclick="showSubmissionDetails(${r.id})">Details</button>
                        <form method="POST" action="{{ url_for('approve_restaurant', id=0) }}" data-id="${r.id}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button class="btn btn-success btn-sm" type="submit">Approve</button>
                        </form>
                        <form method="POST" action="{{ url_for('reject_restaurant', id=0) }}" data-id="${r.id}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button class="btn btn-danger btn-sm" type="submit">Reject</button>
                        </form>
                    </td>
                </tr>`).join('')}
            </tbody></table></div>` : '<p class="text-center text-muted py-4">No pending submissions.</p>'}
        </div>
    </div>`;
}

function renderRestaurantsTab() {
    if (!adminData.approved || adminData.approved.length === 0) {
        return '<p class="text-center text-muted py-4">No restaurants yet.</p>';
    }
    return `
    <div class="card shadow-sm">
        <div class="card-header bg-white"><h4 class="mb-0 fw-bold">üçΩÔ∏è Manage Restaurants</h4></div>
        <div class="card-body">
            <div class="mb-3"><label class="form-check"><input type="checkbox" class="form-check-input" id="restaurantSelectAll"> Select All</label>
            <button class="btn btn-sm btn-danger ms-2" id="restaurantBulkDelete" style="display:none;">Delete Selected</button></div>
            <div class="table-responsive">
                <table class="table table-hover"><thead><tr><th></th><th>Name</th><th>Cuisine</th><th>Reviews</th><th>Rating</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody>
                ${adminData.approved.map(r => `
                    <tr>
                        <td><input class="form-check-input restaurant-checkbox" value="${r.id}" type="checkbox"></td>
                        <td>
                            <div class="d-flex align-items-center gap-3">
                                ${r.image_url ? `<img src="${r.image_url}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">` : '<div style="width:50px;height:50px;background:#e9ecef;border-radius:4px;display:flex;align-items:center;justify-content:center;color:#999">No Image</div>'}
                                <div><a href="#" data-restaurant-id="${r.id}" class="text-decoration-none"><strong>${r.name}</strong></a>${r.is_small_business?'<span class="badge bg-success ms-2">Small Biz</span>':''}</div>
                            </div>
                        </td>
                        <td>${r.cuisine}</td>
                        <td>${r.review_count}</td>
                        <td>${[...Array(5)].map((_,i)=>`<span ${i<Math.floor(r.avg_rating)?'style="color:gold"':''}>‚òÖ</span>`).join('')} <span class="text-muted small">(${r.avg_rating})</span></td>
                        <td>${r.is_promoted?'<span class="badge bg-warning">‚≠ê Promoted</span>' : '<span class="badge bg-secondary">Regular</span>'}</td>
                        <td>
                            <button class="btn btn-sm btn-info edit-restaurant-btn" data-id="${r.id}" data-bs-toggle="modal" data-bs-target="#editRestaurantModal">Edit</button>
                            <form method="POST" action="{{ url_for('toggle_promoted', id=0) }}" data-id="${r.id}" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button class="btn btn-sm btn-outline-warning" type="submit">${r.is_promoted?'Unpromote':'Promote'}</button>
                            </form>
                            <form method="POST" action="{{ url_for('delete_restaurant', id=0) }}" data-id="${r.id}" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button class="btn btn-sm btn-danger" type="submit">Delete</button>
                            </form>
                        </td>
                    </tr>`).join('')}
                </tbody></table>
            </div>
        </div>
    </div>`;
}

function renderUsersTab() {
    if (!adminData.all_users || adminData.all_users.length === 0) return '<p class="text-center text-muted py-4">No users yet.</p>';
    return `
    <div class="card shadow-sm">
        <div class="card-header bg-white"><h4 class="mb-0 fw-bold">üë• Manage Users</h4></div>
        <div class="card-body">
            <div class="mb-3"><label class="form-check"><input type="checkbox" class="form-check-input" id="userSelectAll"> Select All</label>
            <button class="btn btn-sm btn-danger ms-2" id="userBulkDelete" style="display:none;">Delete Selected</button></div>
            <div class="table-responsive"><table class="table table-hover"><thead><tr><th></th><th>Username</th><th>Email</th><th>Role</th><th>Status</th><th>Reviews</th><th>Joined</th><th>Actions</th></tr></thead><tbody>
            ${adminData.all_users.map(u=>`
                <tr>
                    <td><input class="form-check-input user-checkbox" value="${u.id}" type="checkbox"></td>
                    <td><a href="#" data-user-id="${u.id}" class="user-link">${u.username}</a></td>
                    <td>${u.email}</td>
                    <td>${u.is_admin?'<span class="badge bg-danger">Admin</span>':'<span class="badge bg-secondary">User</span>'}</td>
                    <td>${u.is_banned?'<span class="badge bg-danger">üö´ Banned</span>':'<span class="badge bg-success">‚úì Active</span>'}</td>
                    <td></td>
                    <td>${u.review_count}</td>
                    <td><small>${u.created_at}</small></td>
                    <td>
                        <button class="btn btn-sm btn-info edit-user-btn" data-id="${u.id}" data-user-id="${u.id}" data-email="${u.email}" data-bs-toggle="modal" data-bs-target="#editUserModal">Edit</button>
                        <form method="POST" action="{{ url_for('manage_user', id=0) }}" data-id="${u.id}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="toggle_admin">
                            <button class="btn btn-sm btn-outline-primary" type="submit">${u.is_admin?'Demote':'Promote'}</button>
                        </form>
                        ${u.is_banned?`<form method="POST" action="{{ url_for('manage_user', id=0) }}" data-id="${u.id}" style="display:inline;"><input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><input type="hidden" name="action" value="unban"><button class="btn btn-sm btn-outline-success" type="submit">Unban</button></form>`:`<button class="btn btn-sm btn-outline-danger ban-user-btn" data-id="${u.id}" data-user-id="${u.id}" data-bs-toggle="modal" data-bs-target="#banUserModal">Ban</button>`}
                        <form method="POST" action="{{ url_for('manage_user', id=0) }}" data-id="${u.id}" style="display:inline;"><input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><input type="hidden" name="action" value="delete"><button class="btn btn-sm btn-danger" type="submit">Delete</button></form>
                        <button class="btn btn-sm btn-warning assign-badges-btn" data-id="${u.id}" data-user-id="${u.id}" data-bs-toggle="modal" data-bs-target="#assignBadgesModal">Badges</button>
                    </td>
                </tr>`).join('')}
            </tbody></table></div>
        </div>
    </div>`;
}

function renderReviewsTab() {
    const pendingReviews = (adminData.pending_reviews || []).filter(r => !r.is_approved);
    const approvedReviews = (adminData.all_reviews || []).filter(r => r.is_approved);
    
    let html = '';
    
    // Pending reviews section
    if (pendingReviews.length > 0) {
        html += `
        <div class="card shadow-sm mb-4" style="border-left: 4px solid #ff6b6b;">
            <div class="card-header bg-danger text-white"><h5 class="mb-0 fw-bold">üîî Pending Approval (${pendingReviews.length})</h5></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead><tr><th>Author</th><th>Restaurant</th><th>Rating</th><th>Content</th><th>Receipt</th><th>Date</th><th>Actions</th></tr></thead>
                        <tbody>
                            ${pendingReviews.map(r => `
                            <tr style="background-color: rgba(255,107,107,0.05);">
                                <td><strong>${r.author_username}</strong></td>
                                <td><a href="#" data-restaurant-id="${r.restaurant_id}" class="text-decoration-none">${r.restaurant_name}</a></td>
                                <td>${[...Array(5)].map((_, i) => `<span ${i < r.rating ? 'style="color:gold"' : ''}>‚òÖ</span>`).join('')}</td>
                                <td><small>${r.content}</small></td>
                                <td>
                                    ${r.receipt_image ? `<button class="btn btn-sm btn-info view-receipt-btn" data-receipt="${r.receipt_image}" data-bs-toggle="modal" data-bs-target="#viewReceiptModal" title="View receipt">üì∏ View</button>` : '<small class="text-muted">None</small>'}
                                </td>
                                <td><small>${r.created_at}</small></td>
                                <td>
                                    <form method="POST" action="{{ url_for('approve_review', id=0) }}" data-id="${r.id}" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button class="btn btn-sm btn-success" type="submit">‚úì Approve</button>
                                    </form>
                                    <form method="POST" action="{{ url_for('reject_review', id=0) }}" data-id="${r.id}" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button class="btn btn-sm btn-warning" type="submit">‚úï Reject</button>
                                    </form>
                                </td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        `;
    }
    
    // All reviews section
    if (!adminData.all_reviews || adminData.all_reviews.length === 0) return html + '<p class="text-center text-muted py-4">No reviews yet.</p>';
    
    html += `
    <div class="card shadow-sm">
        <div class="card-header bg-white"><h4 class="mb-0 fw-bold">‚≠ê All Reviews</h4></div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-check"><input type="checkbox" class="form-check-input" id="reviewSelectAll"> Select All</label>
                <button class="btn btn-sm btn-danger ms-2" id="reviewBulkDelete" style="display:none;">Delete Selected</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>Author</th>
                            <th>Restaurant</th>
                            <th>Rating</th>
                            <th>Content</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${adminData.all_reviews.map(r => `
                        <tr>
                            <td><input type="checkbox" class="form-check-input review-checkbox" value="${r.id}"></td>
                            <td>${r.author_username}</td>
                            <td><a href="#" data-restaurant-id="${r.restaurant_id}" class="text-decoration-none">${r.restaurant_name}</a></td>
                            <td>${[...Array(5)].map((_, i) => `<span ${i < r.rating ? 'style="color:gold"' : ''}>‚òÖ</span>`).join('')}</td>
                            <td><small>${r.content}</small></td>
                            <td><span class="badge ${r.is_approved ? 'bg-success' : 'bg-warning'}">${r.is_approved ? '‚úì Approved' : 'Pending'}</span></td>
                            <td><small>${r.created_at}</small></td>
                            <td>
                                <form method="POST" action="{{ url_for('delete_review', id=0) }}" data-id="${r.id}" style="display:inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button class="btn btn-sm btn-danger" type="submit">Delete</button>
                                </form>
                            </td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    </div>`;
    
    return html;
}

function renderCuisinesTab() {
    return `
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm"><div class="card-header bg-white"><h4 class="mb-0 fw-bold">‚ûï Add New Cuisine</h4></div>
            <div class="card-body"><form method="POST" action="{{ url_for('add_cuisine') }}"><input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><div class="mb-3"><label class="form-label">Cuisine Name</label><input class="form-control" name="name" required></div><button class="btn btn-primary">Add Cuisine</button></form></div></div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm"><div class="card-header bg-white"><h4 class="mb-0 fw-bold">üìã All Cuisines (${adminData.all_cuisines.length})</h4></div>
            <div class="card-body">
                ${adminData.all_cuisines.length?`<div class="mb-3"><label class="form-check"><input class="form-check-input" id="cuisineSelectAll" type="checkbox"> Select All</label><button class="btn btn-sm btn-danger ms-2" id="cuisineBulkDelete" style="display:none;">Delete Selected</button></div><div class="list-group">${adminData.all_cuisines.map(c=>`<div class="list-group-item d-flex justify-content-between align-items-center"><div><input class="form-check-input cuisine-checkbox me-2" value="${c.id}" type="checkbox"><span>${c.name}</span></div><div><button class="btn btn-sm btn-info edit-cuisine-btn" data-id="${c.id}" data-name="${c.name}" data-bs-toggle="modal" data-bs-target="#editCuisineModal">Edit</button><form method="POST" action="{{ url_for('delete_cuisine', id=0) }}" data-id="${c.id}" style="display:inline;"><input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><button class="btn btn-sm btn-danger" type="submit">Delete</button></form></div></div>`).join('')}</div>`:'<p class="text-center text-muted py-4">No cuisines yet.</p>'}
            </div></div>
        </div>
    </div>`;
}

function renderNewsTab() {
    return `
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white"><h4 class="mb-0 fw-bold">üì∞ News Management</h4></div>
        <div class="card-body px-4 py-4">
            <div class="row mb-3">
                <div class="col-md-6 mb-2">
                    <h6 class="fw-bold mb-3">Quick Actions</h6>
                    <a href="{{ url_for('post_news') }}" class="btn btn-primary btn-sm me-2 mb-2">+ Post New Article</a>
                    <a href="{{ url_for('news') }}" class="btn btn-outline-primary btn-sm mb-2">üëÅÔ∏è View All News</a>
                </div>
            </div>
            <hr>
            <div class="mb-3"><p class="text-muted small mb-2">Use the News tab to share important updates with your community.</p><div class="alert alert-info small mb-0"><strong>üí° Tip:</strong> Announce new restaurants, events, or promotions here.</div></div>
        </div>
    </div>`;
}

function renderBadgesTab() {
    const badges = (adminData.all_badges || []).sort((a, b) => (b.hierarchy || 0) - (a.hierarchy || 0));
    if (!badges.length) return '<p class="text-center text-muted py-4">No badges yet.</p>';
    return `
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0 fw-bold">üéñÔ∏è Manage Badges</h4>
            <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#createBadgeModal">+ Create Badge</button>
        </div>
        <div class="card-body">
            <div class="list-group">${badges.map(b=>`
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <div class="d-flex align-items-center gap-3">
                        <span style="display:inline-block;width:25px;height:25px;background-color:${b.color};border-radius:4px;"></span>
                        <div><h6 class="mb-0 fw-bold">${b.name}</h6><p class="text-muted small mb-0">${b.description||'No description'}</p><p class="text-muted small mb-0">Hierarchy: ${b.hierarchy || 0}</p></div>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <div class="input-group input-group-sm" style="width: 100px;">
                            <input type="number" class="form-control hierarchy-input" value="${b.hierarchy||0}" data-badge-id="${b.id}">
                            <button class="btn btn-outline-primary hierarchy-save-btn" data-badge-id="${b.id}" type="button">Save</button>
                        </div>
                        <button class="btn btn-sm btn-info edit-badge-btn" data-id="${b.id}" data-name="${b.name}" data-color="${b.color}" data-description="${b.description}" data-bs-toggle="modal" data-bs-target="#editBadgeModal">Edit</button>
                        <form method="POST" action="{{ url_for('delete_badge', id=0) }}" data-id="${b.id}" style="display:inline;"><input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><button class="btn btn-sm btn-danger" type="submit">Delete</button></form>
                    </div>
                </div>`).join('')}</div>
        </div>
    </div>`;
}

function renderSettingsTab() {
    const toggles = adminData.feature_toggles || {};
    const featureDisplayNames = {
        'restaurants_enabled': 'üçΩÔ∏è Add Restaurants',
        'reviews_enabled': '‚≠ê Post Reviews',
        'search_enabled': 'üîç Search',
        'leaderboard_enabled': 'üèÜ Leaderboard',
        'news_enabled': 'üì∞ News',
        'profiles_enabled': 'üë§ User Profiles',
        'photo_uploads_enabled': 'üì∏ Photo Uploads',
        'restaurant_filtering_enabled': 'üéØ Filters',
        'user_registration_enabled': 'üìù User Registration',
        'review_comments_enabled': 'üí¨ Review Comments',
        'review_images_enabled': 'üñºÔ∏è Review Images',
        'badges_display_enabled': 'üéñÔ∏è Display Badges',
        'dark_mode_enabled': 'üåô Dark Mode',
        'review_approval_enabled': '‚úÖ Review Approval',
        'content_reporting_enabled': 'üö© Report Content',
        'maintenance_mode': 'üîß Maintenance Mode'
    };
    const keys = Object.keys(toggles);
    if (!keys.length) return '<p class="text-center text-muted py-4">No settings available.</p>';
    return `<div class="card shadow-sm"><div class="card-header bg-warning text-dark"><h4 class="mb-0 fw-bold">‚öôÔ∏è Website Settings</h4></div><div class="card-body"><div class="list-group">${keys.map(fn=>{
        const f = toggles[fn];
        return `<div class="d-flex justify-content-between align-items-center p-3 border-bottom"><div><h6 class="mb-1 fw-bold">${featureDisplayNames[fn]||fn}</h6><p class="text-muted small mb-0">${f.description||''}</p></div><div class="d-flex align-items-center gap-3">${f.is_enabled?'<span class="badge bg-success">Enabled</span>' : '<span class="badge bg-danger">Disabled</span>'}<button class="btn btn-sm ${f.is_enabled?'btn-danger':'btn-success'} feature-toggle-btn" data-feature="${fn}">${f.is_enabled?'Disable':'Enable'}</button></div></div>`;
    }).join('')}</div></div></div>`;
}

// toggle feature via API
async function toggleFeature(featureName) {
    try {
        const url = `{{ url_for('toggle_feature', feature_name='PLACEHOLDER') }}`.replace('PLACEHOLDER', featureName);
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type':'application/json', 'X-CSRFToken': csrfToken }, credentials: 'same-origin' });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Toggle failed');
        await loadAdminData();
        renderTab('settings');
    } catch (err) {
        console.error('Error toggling feature:', err);
        alert('Error toggling feature: ' + (err.message || err));
    }
}

// Show submission details (used by Overview)
function showSubmissionDetails(id) {
    const r = (adminData.pending || []).find(x => x.id === id);
    if (!r) return;
    const content = `
        ${r.image_url?`<div class="mb-4"><h6 class="text-muted small">Restaurant Image</h6><img src="${r.image_url}" style="max-width:100%;border-radius:8px;"></div>`:''}
        <div class="row mb-4"><div class="col-md-6"><h6 class="text-muted small">Restaurant Name</h6><p class="fw-bold">${r.name}</p></div><div class="col-md-6"><h6 class="text-muted small">Cuisine</h6><p class="fw-bold">${r.cuisine}</p></div></div>
        <div class="mb-4"><h6 class="text-muted small">Description</h6><p>${r.full_description}</p></div>
        <div class="row mb-4"><div class="col-md-6"><h6 class="text-muted small">Working Hours</h6><p>${r.working_hours||'Not provided'}</p></div><div class="col-md-6"><h6 class="text-muted small">Price Range</h6><p>${'$'.repeat(r.price_range)}</p></div></div>
        <div class="mb-4 pb-3 border-top"><h6 class="text-muted small">Food Categories</h6><div>${(r.food_categories||[]).length? (r.food_categories||[]).map(t=>`<span class="badge bg-info me-1">${t}</span>`).join(' ') : '<span class="text-muted">No food categories</span>'}</div></div>
        <div class="alert alert-info"><h6 class="alert-heading">Submitted By</h6><p class="mb-2"><strong>Username:</strong> ${r.submitter_username}</p><p class="mb-0"><strong>Email:</strong> ${r.submitter_email}</p></div>
    `;
    document.getElementById('submissionDetailsContent').innerHTML = content;
    const modal = new bootstrap.Modal(document.getElementById('submissionDetailsModal'));
    modal.show();
}

// Initialization
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('#adminTabs button').forEach(btn => {
        btn.addEventListener('click', () => renderTab(btn.dataset.tab));
    });
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    if (autoRefreshToggle) {
        autoRefreshToggle.addEventListener('change', function() {
            autoRefreshEnabled = this.checked;
            if (autoRefreshEnabled) {
                if (!refreshInterval) refreshInterval = setInterval(loadAdminData, 5000);
                loadAdminData();
            } else {
                if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null; }
            }
        });
    }
    loadAdminData();
    if (autoRefreshEnabled) refreshInterval = setInterval(loadAdminData, 5000);
});
</script>

{% endblock %}
