{% extends "base.html" %}

{% block title %}Admin Dashboard - Yalla{% endblock %}

{% block content %}
<div class="bg-primary text-white py-4">
    <div class="container d-flex justify-content-between align-items-center">
        <h2 class="fw-bold mb-0">üîß Admin Control Panel</h2>
        <div>
            <small class="text-white-50">Auto-refreshing every 5 seconds</small>
            <div class="form-check form-switch d-inline-block ms-3">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                <label class="form-check-label text-white-50" for="autoRefreshToggle">
                    Auto-Refresh
                </label>
            </div>
        </div>
    </div>
</div>

<div class="container py-5">
    <!-- Submission Details Modal -->
    <div class="modal fade" id="submissionDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Restaurant Submission Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="submissionDetailsContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ban User Modal -->
    <div class="modal fade" id="banUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ban User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" id="banUserForm" action="{{ url_for('manage_user', id=0) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="ban">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="banReason" class="form-label">Username</label>
                            <input type="text" class="form-control" id="banUsername" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="banReason" class="form-label">Ban Reason</label>
                            <textarea class="form-control" id="banReason" name="ban_reason" rows="4" placeholder="Enter the reason for banning this user..." required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Ban User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" role="tablist" id="adminTabs">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-tab="overview" type="button" role="tab">
                üìä Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="restaurants-tab" data-tab="restaurants" type="button" role="tab">
                üçΩÔ∏è Restaurants
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-tab="users" type="button" role="tab">
                üë• Users
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reviews-tab" data-tab="reviews" type="button" role="tab">
                ‚≠ê Reviews
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cuisines-tab" data-tab="cuisines" type="button" role="tab">
                üç¥ Cuisines
            </button>
        </li>
    </ul>

    <!-- Tab Content Container -->
    <div id="tabContent"></div>
</div>

<script>
let adminData = null;
let currentTab = 'overview';
let autoRefreshEnabled = true;
let refreshInterval = null;

// Load all admin data
async function loadAdminData() {
    try {
        const response = await fetch('{{ url_for("admin_api_data") }}');
        const data = await response.json();
        adminData = data;
        renderTab(currentTab);
    } catch (error) {
        console.error('Failed to load admin data:', error);
    }
}

// Render specific tab
function renderTab(tabName) {
    currentTab = tabName;
    const container = document.getElementById('tabContent');
    
    // Update active tab button
    document.querySelectorAll('#adminTabs button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    let html = '';
    
    if (tabName === 'overview') {
        html = renderOverviewTab();
    } else if (tabName === 'restaurants') {
        html = renderRestaurantsTab();
    } else if (tabName === 'users') {
        html = renderUsersTab();
    } else if (tabName === 'reviews') {
        html = renderReviewsTab();
    } else if (tabName === 'cuisines') {
        html = renderCuisinesTab();
    }
    
    container.innerHTML = html;
    attachEventListeners();
}

function renderOverviewTab() {
    let html = `
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="fw-bold text-primary mb-0">${adminData.pending.length}</h3>
                    <p class="text-muted small mb-0">Pending Approvals</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="fw-bold text-success mb-0">${adminData.approved.length}</h3>
                    <p class="text-muted small mb-0">Approved Restaurants</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="fw-bold text-info mb-0">${adminData.total_users}</h3>
                    <p class="text-muted small mb-0">Total Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="fw-bold text-warning mb-0">${adminData.total_reviews}</h3>
                    <p class="text-muted small mb-0">Total Reviews</p>
                </div>
            </div>
        </div>
    </div>`;
    
    if (adminData.pending.length > 0) {
        html += `
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0 fw-bold">‚ö†Ô∏è Pending Restaurant Submissions</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Restaurant Name</th>
                                <th>Cuisine</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${adminData.pending.map(r => `
                            <tr>
                                <td>
                                    <strong>${r.name}</strong>
                                    ${r.is_small_business ? '<span class="badge bg-success ms-2">Small Business</span>' : ''}
                                    <br>
                                    <small class="text-muted">${r.description}...</small>
                                </td>
                                <td>${r.cuisine}</td>
                                <td>${r.created_at}</td>
                                <td>
                                    <button type="button" class="btn btn-info btn-sm view-details-btn" data-id="${r.id}" data-bs-toggle="modal" data-bs-target="#submissionDetailsModal" onclick="showSubmissionDetails(${r.id})">Details</button>
                                    <form method="POST" action="{{ url_for('approve_restaurant', id=0) }}" style="display: inline;" data-id="${r.id}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-success btn-sm approve-btn" data-id="${r.id}">Approve</button>
                                    </form>
                                    <form method="POST" action="{{ url_for('reject_restaurant', id=0) }}" style="display: inline;" data-id="${r.id}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-danger btn-sm reject-btn" data-id="${r.id}">Reject</button>
                                    </form>
                                </td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>`;
    }
    
    return html;
}

function renderRestaurantsTab() {
    if (adminData.approved.length === 0) {
        return '<p class="text-center text-muted py-4">No restaurants yet.</p>';
    }
    
    return `
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h4 class="mb-0 fw-bold">üçΩÔ∏è Manage Restaurants</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Cuisine</th>
                            <th>Reviews</th>
                            <th>Rating</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${adminData.approved.map(r => `
                        <tr>
                            <td>
                                <a href="{{ url_for('restaurant_detail', id=0) }}" target="_blank" class="text-decoration-none" data-id="${r.id}">
                                    <strong>${r.name}</strong>
                                </a>
                                ${r.is_small_business ? '<span class="badge bg-success ms-2">Small Biz</span>' : ''}
                            </td>
                            <td>${r.cuisine}</td>
                            <td>${r.review_count}</td>
                            <td>
                                ${[...Array(5)].map((_, i) => `
                                    <span ${i < Math.floor(r.avg_rating) ? 'style="color: gold;"' : ''}>‚òÖ</span>
                                `).join('')}
                                <span class="text-muted small">(${r.avg_rating})</span>
                            </td>
                            <td>
                                ${r.is_featured ? '<span class="badge bg-warning">‚≠ê Featured</span>' : '<span class="badge bg-secondary">Regular</span>'}
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('toggle_featured', id=0) }}" style="display: inline;" data-id="${r.id}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-outline-warning feature-btn" data-id="${r.id}">
                                        ${r.is_featured ? 'Unfeature' : 'Feature'}
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('delete_restaurant', id=0) }}" style="display: inline;" data-id="${r.id}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-danger delete-btn" data-id="${r.id}">Delete</button>
                                </form>
                            </td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    </div>`;
}

function renderUsersTab() {
    if (adminData.all_users.length === 0) {
        return '<p class="text-center text-muted py-4">No users yet.</p>';
    }
    
    return `
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h4 class="mb-0 fw-bold">üë• Manage Users</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Reputation</th>
                            <th>Reviews</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${adminData.all_users.map(u => `
                        <tr>
                            <td>
                                <a href="{{ url_for('profile', username='') }}" target="_blank" class="text-decoration-none user-link" data-username="${u.username}">
                                    <strong>${u.username}</strong>
                                </a>
                            </td>
                            <td>${u.email}</td>
                            <td>
                                ${u.is_admin ? '<span class="badge bg-danger">Admin</span>' : '<span class="badge bg-secondary">User</span>'}
                            </td>
                            <td>
                                ${u.is_banned ? '<span class="badge bg-danger">üö´ Banned</span>' : '<span class="badge bg-success">‚úì Active</span>'}
                            </td>
                            <td><span class="badge bg-info">${u.reputation_score}</span></td>
                            <td>${u.review_count}</td>
                            <td><small>${u.created_at}</small></td>
                            <td>
                                <form method="POST" action="{{ url_for('manage_user', id=0) }}" style="display: inline;" data-id="${u.id}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="action" value="toggle_admin">
                                    <button type="submit" class="btn btn-sm btn-outline-primary toggle-admin-btn" data-id="${u.id}">
                                        ${u.is_admin ? 'Demote' : 'Promote'}
                                    </button>
                                </form>
                                ${u.is_banned ? `
                                <form method="POST" action="{{ url_for('manage_user', id=0) }}" style="display: inline;" data-id="${u.id}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="action" value="unban">
                                    <button type="submit" class="btn btn-sm btn-outline-success unban-user-btn" data-id="${u.id}">Unban</button>
                                </form>
                                ` : `
                                <button type="button" class="btn btn-sm btn-outline-danger ban-user-btn" data-id="${u.id}" data-username="${u.username}">Ban</button>
                                `}
                                <form method="POST" action="{{ url_for('manage_user', id=0) }}" style="display: inline;" data-id="${u.id}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="action" value="delete">
                                    <button type="submit" class="btn btn-sm btn-danger delete-user-btn" data-id="${u.id}">Delete</button>
                                </form>
                            </td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    </div>`;
}

function renderReviewsTab() {
    if (adminData.all_reviews.length === 0) {
        return '<p class="text-center text-muted py-4">No reviews yet.</p>';
    }
    
    return `
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h4 class="mb-0 fw-bold">‚≠ê Manage Reviews</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Author</th>
                            <th>Restaurant</th>
                            <th>Rating</th>
                            <th>Content</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${adminData.all_reviews.map(r => `
                        <tr>
                            <td>
                                ${r.author_username === 'Deleted User' ? '<span class="text-muted">Deleted User</span>' : `
                                <a href="{{ url_for('profile', username='') }}" target="_blank" class="text-decoration-none user-link" data-username="${r.author_username}">
                                    ${r.author_username}
                                </a>`}
                            </td>
                            <td>
                                <a href="{{ url_for('restaurant_detail', id=0) }}" target="_blank" class="text-decoration-none" data-id="${r.restaurant_id}">
                                    ${r.restaurant_name}
                                </a>
                            </td>
                            <td>
                                ${[...Array(5)].map((_, i) => `<span ${i < r.rating ? 'style="color: gold;"' : ''}>‚òÖ</span>`).join('')}
                            </td>
                            <td>
                                ${r.title ? `<strong>${r.title}</strong><br>` : ''}
                                <small>${r.content}</small>
                            </td>
                            <td><small>${r.created_at}</small></td>
                            <td>
                                <form method="POST" action="{{ url_for('delete_review', id=0) }}" style="display: inline;" data-id="${r.id}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-danger delete-review-btn" data-id="${r.id}">Delete</button>
                                </form>
                            </td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    </div>`;
}

function renderCuisinesTab() {
    return `
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h4 class="mb-0 fw-bold">‚ûï Add New Cuisine</h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('add_cuisine') }}" id="addCuisineForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="cuisine_name" class="form-label">Cuisine Name</label>
                            <input type="text" class="form-control" id="cuisine_name" name="name" required placeholder="e.g., Thai, Korean, Indian">
                        </div>
                        <button type="submit" class="btn btn-primary">Add Cuisine</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h4 class="mb-0 fw-bold">üìã All Cuisines (${adminData.all_cuisines.length})</h4>
                </div>
                <div class="card-body">
                    ${adminData.all_cuisines.length > 0 ? `
                    <div class="list-group">
                        ${adminData.all_cuisines.map(c => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>${c.name}</span>
                            <form method="POST" action="{{ url_for('delete_cuisine', id=0) }}" style="display: inline;" data-id="${c.id}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-danger delete-cuisine-btn" data-id="${c.id}">Delete</button>
                            </form>
                        </div>
                        `).join('')}
                    </div>
                    ` : '<p class="text-center text-muted py-4">No cuisines yet.</p>'}
                </div>
            </div>
        </div>
    </div>`;
}

function attachEventListeners() {
    // Update form action attributes with proper IDs - handle both inline and full URLs
    document.querySelectorAll('form[data-id]').forEach(form => {
        const id = form.dataset.id;
        form.addEventListener('submit', function(e) {
            const baseAction = this.action;
            // Replace /0 with the actual ID anywhere in the URL
            this.action = baseAction.replace(/\/0(?=\s|$|\/|#|\?|&)/, `/${id}`);
        });
    });
    
    // Update links with proper IDs
    document.querySelectorAll('a[data-id]').forEach(link => {
        const id = link.dataset.id;
        link.href = `{{ url_for('restaurant_detail', id=0) }}`.replace('/0', `/${id}`);
    });
    
    document.querySelectorAll('a[data-username]').forEach(link => {
        const username = link.dataset.username;
        link.href = `{{ url_for('profile', username='') }}${username}`;
    });
    
    // Ban user button handler
    document.querySelectorAll('.ban-user-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const username = this.dataset.username;
            const userId = this.dataset.id;
            document.getElementById('banUsername').value = username;
            document.getElementById('banReason').value = '';
            const banUserForm = document.getElementById('banUserForm');
            const baseUrl = `{{ url_for('manage_user', id=0) }}`;
            banUserForm.action = baseUrl.replace('/0', `/${userId}`);
            const modal = new bootstrap.Modal(document.getElementById('banUserModal'));
            modal.show();
        });
    });
}

// Show submission details in modal
function showSubmissionDetails(restaurantId) {
    const restaurant = adminData.pending.find(r => r.id === restaurantId);
    if (!restaurant) return;
    
    const content = `
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="text-muted small">Restaurant Name</h6>
                <p class="fw-bold">${restaurant.name}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted small">Cuisine</h6>
                <p class="fw-bold">${restaurant.cuisine}</p>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="text-muted small">Address</h6>
                <p>${restaurant.address || 'Not provided'}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted small">Phone</h6>
                <p>${restaurant.phone || 'Not provided'}</p>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="text-muted small">Working Hours</h6>
                <p>${restaurant.working_hours || 'Not provided'}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted small">Price Range</h6>
                <p>${'$'.repeat(restaurant.price_range)}</p>
            </div>
        </div>
        
        <div class="mb-4">
            <h6 class="text-muted small">Description</h6>
            <p>${restaurant.full_description}</p>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="text-muted small">Small Business</h6>
                <p><span class="badge ${restaurant.is_small_business ? 'bg-success' : 'bg-secondary'}">${restaurant.is_small_business ? 'Yes' : 'No'}</span></p>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted small">Submitted Date</h6>
                <p>${restaurant.created_at}</p>
            </div>
        </div>
        
        <div class="mb-4 pb-3 border-bottom">
            <h6 class="text-muted small">Dietary Options</h6>
            <div>
                ${restaurant.has_vegetarian ? '<span class="badge bg-success">Vegetarian</span>' : ''}
                ${restaurant.has_vegan ? '<span class="badge bg-success">Vegan</span>' : ''}
                ${restaurant.is_halal ? '<span class="badge bg-success">Halal</span>' : ''}
                ${restaurant.has_gluten_free ? '<span class="badge bg-success">Gluten-Free</span>' : ''}
            </div>
        </div>
        
        <div class="alert alert-info">
            <h6 class="alert-heading">Submitted By</h6>
            <p class="mb-2"><strong>Username:</strong> ${restaurant.submitter_username}</p>
            <p class="mb-0"><strong>Email:</strong> ${restaurant.submitter_email}</p>
        </div>
    `;
    
    document.getElementById('submissionDetailsContent').innerHTML = content;
}

// Set up auto-refresh
document.addEventListener('DOMContentLoaded', function() {
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    
    // Tab switching
    document.querySelectorAll('#adminTabs button').forEach(btn => {
        btn.addEventListener('click', () => {
            renderTab(btn.dataset.tab);
        });
    });
    
    // Auto-refresh toggle
    if (autoRefreshToggle) {
        autoRefreshToggle.addEventListener('change', function() {
            autoRefreshEnabled = this.checked;
            if (autoRefreshEnabled && !refreshInterval) {
                refreshInterval = setInterval(loadAdminData, 5000);
                loadAdminData();
            } else if (!autoRefreshEnabled && refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        });
    }
    
    // Initial load
    loadAdminData();
    if (autoRefreshEnabled) {
        refreshInterval = setInterval(loadAdminData, 5000);
    }
});
</script>
{% endblock %}
