<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Yalla - Discover Jeddah's Best Restaurants{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">
                Loading Yalla<span class="loading-dots"></span>
            </div>
        </div>
    </div>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary fs-3" href="{{ url_for('index') }}">
                Yalla
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('restaurants') }}">Restaurants</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('leaderboard') }}">Leaderboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('news') }}">News</a>
                    </li>
                    {% if current_user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('add_restaurant') }}">Add Restaurant</a>
                    </li>
                    {% if current_user.is_admin %}
                    <li class="nav-item">
                        <a class="nav-link text-warning fw-bold" href="{{ url_for('admin_dashboard') }}">Admin</a>
                    </li>
                    {% endif %}
                    {% endif %}
                </ul>
                <form class="d-flex me-3" action="{{ url_for('search') }}" method="GET">
                    <input class="form-control me-2" type="search" name="q" placeholder="Search restaurants..." aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
                <ul class="navbar-nav">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            {{ current_user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('profile', username=current_user.username) }}">My Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('login') }}">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-primary btn-sm" href="{{ url_for('register') }}">Sign Up</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}

    <footer class="bg-dark text-white mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="fw-bold">Yalla</h5>
                    <p>Discover Jeddah's hidden culinary gems and support local businesses.</p>
                </div>
                <div class="col-md-3">
                    <h6>Quick Links</h6>
                    <ul class="list-unstyled">
                        <li><a href="{{ url_for('index') }}" class="text-white-50">Home</a></li>
                        <li><a href="{{ url_for('restaurants') }}" class="text-white-50">Restaurants</a></li>
                        <li><a href="{{ url_for('add_restaurant') }}" class="text-white-50">Add Restaurant</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h6>Community</h6>
                    <p class="text-white-50">Join our community of food lovers in Jeddah!</p>
                </div>
            </div>
            <hr class="bg-white">
            <div class="text-center">
                <p class="mb-0">&copy; 2024 Yalla. Supporting Jeddah's food community.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script>
        // Hide loading screen when page fully loads
        window.addEventListener('load', function() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
        });
    </script>
    <script>
        // Carousel auto-scroll configuration
        const carouselAutoScroll = {
            'promoted-carousel': null,
            'recent-carousel': null
        };

        // Function to update blur on peek items with graduated fade (responsive)
        function updatePeekEffect(carouselId) {
            const carousel = document.getElementById(carouselId);
            if (!carousel) return;
            
            const items = carousel.querySelectorAll('.horizontal-scroll-item');
            if (items.length === 0) return;
            
            const viewportCenter = carousel.scrollLeft + carousel.clientWidth / 2;
            const itemWidth = items[0].offsetWidth + 24; // Actual card width + gap
            const viewportWidth = carousel.clientWidth;
            
            // Determine thresholds based on viewport width
            let centerThreshold, fadeThreshold;
            if (viewportWidth < 576) {
                // Mobile: show 1 item
                centerThreshold = itemWidth / 2 + 50;
                fadeThreshold = itemWidth;
            } else if (viewportWidth < 768) {
                // Tablet: show 2 items
                centerThreshold = itemWidth + 50;
                fadeThreshold = itemWidth * 1.5;
            } else {
                // Desktop: show 3 items
                centerThreshold = itemWidth * 1.5 + 50;
                fadeThreshold = itemWidth * 2;
            }
            
            items.forEach((item, index) => {
                const itemCenter = index * itemWidth + itemWidth / 2;
                const distanceFromCenter = Math.abs(itemCenter - viewportCenter);
                
                // Calculate fade based on distance from center
                if (distanceFromCenter < centerThreshold) {
                    // Center items - fully visible
                    item.classList.remove('peek');
                    item.classList.remove('fade-peek');
                } else if (distanceFromCenter < fadeThreshold) {
                    // Mid-range items - slight fade
                    item.classList.add('fade-peek');
                    item.classList.remove('peek');
                } else {
                    // Edge items - heavy blur
                    item.classList.add('peek');
                    item.classList.remove('fade-peek');
                }
            });
        }

        // Function to scroll carousel
        function scrollCarousel(carouselType, direction) {
            const carouselId = carouselType === 'promoted' ? 'promoted-carousel' : 'recent-carousel';
            const carousel = document.getElementById(carouselId);
            if (carousel) {
                const itemWidth = 320 + 24; // Card width + gap
                const distance = direction > 0 ? itemWidth : -itemWidth;
                
                carousel.scrollBy({
                    left: distance,
                    behavior: 'smooth'
                });
                // Reset auto-scroll timer when user clicks
                resetAutoScroll(carouselId);
            }
        }

        // Function to auto-scroll carousel
        function autoScroll(carouselId) {
            const carousel = document.getElementById(carouselId);
            if (carousel) {
                const itemWidth = 320 + 24; // Card width + gap
                
                carousel.scrollBy({
                    left: itemWidth,
                    behavior: 'smooth'
                });
                // Reset timer
                resetAutoScroll(carouselId);
            }
        }

        // Function to reset auto-scroll timer
        function resetAutoScroll(carouselId) {
            // Clear existing timer
            if (carouselAutoScroll[carouselId]) {
                clearInterval(carouselAutoScroll[carouselId]);
            }
            // Set new timer (5 seconds)
            carouselAutoScroll[carouselId] = setInterval(() => {
                autoScroll(carouselId);
            }, 5000);
        }
        
        // Function to handle scroll wrapping for infinite loop
        function handleInfiniteScroll(carousel) {
            const itemWidth = 320 + 24; // Card width + gap
            const maxScroll = carousel.scrollWidth - carousel.clientWidth;
            
            // If we scroll past the end, loop back
            if (carousel.scrollLeft >= maxScroll - 10) {
                carousel.scrollLeft = 0;
            }
        }

        // Initialize auto-scroll for both carousels when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const carousels = ['promoted-carousel', 'recent-carousel'];
            
            carousels.forEach(carouselId => {
                const carousel = document.getElementById(carouselId);
                if (carousel) {
                    // Clone items for infinite scroll effect
                    setTimeout(() => {
                        const items = carousel.querySelectorAll('.horizontal-scroll-item');
                        if (items.length > 0) {
                            // Clone all items and append to create infinite loop
                            items.forEach(item => {
                                const clone = item.cloneNode(true);
                                carousel.appendChild(clone);
                            });
                            
                            // Initial peek effect setup
                            updatePeekEffect(carouselId);
                        }
                    }, 50);
                    
                    // Update peek effect on scroll and handle infinite loop
                    carousel.addEventListener('scroll', function() {
                        updatePeekEffect(carouselId);
                        
                        // Check if we need to reset to start for seamless looping
                        const items = carousel.querySelectorAll('.horizontal-scroll-item');
                        const itemWidth = 320 + 24; // Card width + gap
                        const maxScroll = carousel.scrollWidth - carousel.clientWidth;
                        
                        if (carousel.scrollLeft >= maxScroll - (itemWidth * 2)) {
                            // Reset to start smoothly
                            setTimeout(() => {
                                carousel.scrollLeft = 0;
                                updatePeekEffect(carouselId);
                            }, 300);
                        }
                    });
                    
                    // Start auto-scroll
                    resetAutoScroll(carouselId);
                }
            });
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
