{% extends "base.html" %}

{% block title %}Admin Dashboard - Yalla{% endblock %}

{% block content %}
<div class="bg-primary text-white py-4">
    <div class="container d-flex justify-content-between align-items-center">
        <h2 class="fw-bold mb-0">üîß Admin Control Panel</h2>
        <div>
            <small class="text-white-50">Auto-refreshing every 5 seconds</small>
            <div class="form-check form-switch d-inline-block ms-3">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                <label class="form-check-label text-white-50" for="autoRefreshToggle">
                    Auto-Refresh
                </label>
            </div>
        </div>
    </div>
</div>

<div class="container py-5">
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if tab == 'overview' %}active{% endif %}" href="{{ url_for('admin_dashboard', tab='overview') }}">
                üìä Overview
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if tab == 'restaurants' %}active{% endif %}" href="{{ url_for('admin_dashboard', tab='restaurants') }}">
                üçΩÔ∏è Restaurants
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if tab == 'users' %}active{% endif %}" href="{{ url_for('admin_dashboard', tab='users') }}">
                üë• Users
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if tab == 'reviews' %}active{% endif %}" href="{{ url_for('admin_dashboard', tab='reviews') }}">
                ‚≠ê Reviews
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if tab == 'cuisines' %}active{% endif %}" href="{{ url_for('admin_dashboard', tab='cuisines') }}">
                üç¥ Cuisines
            </a>
        </li>
    </ul>

    <!-- OVERVIEW TAB -->
    {% if tab == 'overview' %}
    <div class="row mb-4" id="statsContainer">
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="fw-bold text-primary mb-0" id="pendingCount">{{ pending|length }}</h3>
                    <p class="text-muted small mb-0">Pending Approvals</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="fw-bold text-success mb-0" id="approvedCount">{{ approved|length }}</h3>
                    <p class="text-muted small mb-0">Approved Restaurants</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="fw-bold text-info mb-0" id="usersCount">{{ total_users }}</h3>
                    <p class="text-muted small mb-0">Total Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="fw-bold text-warning mb-0" id="reviewsCount">{{ total_reviews }}</h3>
                    <p class="text-muted small mb-0">Total Reviews</p>
                </div>
            </div>
        </div>
    </div>
    
    {% if pending %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0 fw-bold">‚ö†Ô∏è Pending Restaurant Submissions</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Restaurant Name</th>
                            <th>Cuisine</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for restaurant in pending %}
                        <tr>
                            <td>
                                <strong>{{ restaurant.name }}</strong>
                                {% if restaurant.is_small_business %}
                                <span class="badge bg-success ms-2">Small Business</span>
                                {% endif %}
                                <br>
                                <small class="text-muted">{{ restaurant.description[:100] }}...</small>
                            </td>
                            <td>{{ restaurant.cuisine.name }}</td>
                            <td>{{ restaurant.created_at.strftime('%b %d, %Y') }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('approve_restaurant', id=restaurant.id) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-success btn-sm">Approve</button>
                                </form>
                                <form method="POST" action="{{ url_for('reject_restaurant', id=restaurant.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure?')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- RESTAURANTS TAB -->
    {% if tab == 'restaurants' %}
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h4 class="mb-0 fw-bold">üçΩÔ∏è Manage Restaurants</h4>
        </div>
        <div class="card-body">
            {% if approved %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Cuisine</th>
                            <th>Reviews</th>
                            <th>Rating</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for restaurant in approved %}
                        <tr>
                            <td>
                                <a href="{{ url_for('restaurant_detail', id=restaurant.id) }}" target="_blank" class="text-decoration-none">
                                    <strong>{{ restaurant.name }}</strong>
                                </a>
                                {% if restaurant.is_small_business %}
                                <span class="badge bg-success ms-2">Small Biz</span>
                                {% endif %}
                            </td>
                            <td>{{ restaurant.cuisine.name }}</td>
                            <td>{{ restaurant.review_count() }}</td>
                            <td>
                                {% set rating = restaurant.avg_rating() %}
                                {% for i in range(5) %}
                                    {% if i < rating %}
                                    <span class="star filled" style="color: gold;">‚òÖ</span>
                                    {% else %}
                                    <span class="star">‚òÜ</span>
                                    {% endif %}
                                {% endfor %}
                                <span class="text-muted small">({{ restaurant.avg_rating() }})</span>
                            </td>
                            <td>
                                {% if restaurant.is_featured %}
                                <span class="badge bg-warning">‚≠ê Featured</span>
                                {% else %}
                                <span class="badge bg-secondary">Regular</span>
                                {% endif %}
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('toggle_featured', id=restaurant.id) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-outline-warning">
                                        {% if restaurant.is_featured %}Unfeature{% else %}Feature{% endif %}
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('delete_restaurant', id=restaurant.id) }}" style="display: inline;" onsubmit="return confirm('Delete this restaurant?')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted py-4">No restaurants yet.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- USERS TAB -->
    {% if tab == 'users' %}
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h4 class="mb-0 fw-bold">üë• Manage Users</h4>
        </div>
        <div class="card-body">
            {% if all_users %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Reputation</th>
                            <th>Reviews</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in all_users %}
                        <tr>
                            <td>
                                <a href="{{ url_for('profile', username=user.username) }}" target="_blank" class="text-decoration-none">
                                    <strong>{{ user.username }}</strong>
                                </a>
                            </td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% if user.is_admin %}
                                <span class="badge bg-danger">Admin</span>
                                {% else %}
                                <span class="badge bg-secondary">User</span>
                                {% endif %}
                            </td>
                            <td><span class="badge bg-info">{{ user.reputation_score }}</span></td>
                            <td>{{ user.review_count() }}</td>
                            <td><small>{{ user.created_at.strftime('%b %d, %Y') }}</small></td>
                            <td>
                                <form method="POST" action="{{ url_for('manage_user', id=user.id) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="action" value="toggle_admin">
                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                        {% if user.is_admin %}Demote{% else %}Promote{% endif %}
                                    </button>
                                </form>
                                {% if user.id != current_user.id %}
                                <form method="POST" action="{{ url_for('manage_user', id=user.id) }}" style="display: inline;" onsubmit="return confirm('Delete this user?')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="action" value="delete">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted py-4">No users yet.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- REVIEWS TAB -->
    {% if tab == 'reviews' %}
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h4 class="mb-0 fw-bold">‚≠ê Manage Reviews</h4>
        </div>
        <div class="card-body">
            {% if all_reviews %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Author</th>
                            <th>Restaurant</th>
                            <th>Rating</th>
                            <th>Content</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for review in all_reviews %}
                        <tr>
                            <td>
                                {% if review.author %}
                                <a href="{{ url_for('profile', username=review.author.username) }}" target="_blank" class="text-decoration-none">
                                    {{ review.author.username }}
                                </a>
                                {% else %}
                                <span class="text-muted">Deleted User</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('restaurant_detail', id=review.restaurant.id) }}" target="_blank" class="text-decoration-none">
                                    {{ review.restaurant.name }}
                                </a>
                            </td>
                            <td>
                                {% for i in range(5) %}
                                    {% if i < review.rating %}
                                    <span style="color: gold;">‚òÖ</span>
                                    {% else %}
                                    <span>‚òÜ</span>
                                    {% endif %}
                                {% endfor %}
                            </td>
                            <td>
                                {% if review.title %}
                                <strong>{{ review.title }}</strong><br>
                                {% endif %}
                                <small>{{ review.content[:80] }}...</small>
                            </td>
                            <td><small>{{ review.created_at.strftime('%b %d, %Y') }}</small></td>
                            <td>
                                <form method="POST" action="{{ url_for('delete_review', id=review.id) }}" style="display: inline;" onsubmit="return confirm('Delete this review?')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted py-4">No reviews yet.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- CUISINES TAB -->
    {% if tab == 'cuisines' %}
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h4 class="mb-0 fw-bold">‚ûï Add New Cuisine</h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('add_cuisine') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="cuisine_name" class="form-label">Cuisine Name</label>
                            <input type="text" class="form-control" id="cuisine_name" name="name" required placeholder="e.g., Thai, Korean, Indian">
                        </div>
                        <button type="submit" class="btn btn-primary">Add Cuisine</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h4 class="mb-0 fw-bold">üìã All Cuisines ({{ all_cuisines|length }})</h4>
                </div>
                <div class="card-body">
                    {% if all_cuisines %}
                    <div class="list-group">
                        {% for cuisine in all_cuisines %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ cuisine.name }}</span>
                            <form method="POST" action="{{ url_for('delete_cuisine', id=cuisine.id) }}" style="display: inline;" onsubmit="return confirm('Delete this cuisine?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-center text-muted py-4">No cuisines yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Auto-refresh admin dashboard data
let autoRefreshEnabled = true;
let refreshInterval = null;

function updateAdminData() {
    if (!autoRefreshEnabled) return;
    
    fetch('{{ url_for("admin_api_data") }}')
        .then(response => response.json())
        .then(data => {
            const statsContainer = document.getElementById('statsContainer');
            if (statsContainer) {
                document.getElementById('pendingCount').textContent = data.pending_count;
                document.getElementById('approvedCount').textContent = data.approved_count;
                document.getElementById('usersCount').textContent = data.total_users;
                document.getElementById('reviewsCount').textContent = data.total_reviews;
                
                // Add a subtle visual feedback
                statsContainer.style.opacity = '0.8';
                setTimeout(() => {
                    statsContainer.style.opacity = '1';
                }, 200);
            }
        })
        .catch(error => console.log('Auto-refresh error:', error));
}

// Set up auto-refresh
document.addEventListener('DOMContentLoaded', function() {
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    
    if (autoRefreshToggle) {
        autoRefreshToggle.addEventListener('change', function() {
            autoRefreshEnabled = this.checked;
            if (autoRefreshEnabled && !refreshInterval) {
                refreshInterval = setInterval(updateAdminData, 5000);
                updateAdminData(); // Update immediately
            } else if (!autoRefreshEnabled && refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        });
    }
    
    // Start auto-refresh on page load
    if (autoRefreshEnabled) {
        refreshInterval = setInterval(updateAdminData, 5000);
    }
});
</script>

<style>
#statsContainer {
    transition: opacity 0.3s ease;
}
</style>
{% endblock %}
