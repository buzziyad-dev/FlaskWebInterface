<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Yalla - Discover Jeddah's Best Restaurants{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body id="appBody">
    <form id="darkModeForm" action="/save_dark_mode" method="POST" style="display:none;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="darkMode" id="darkModeInput">
    </form>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="text-center text-white">
            <div class="loading-spinner mb-4"></div>
            <p class="fs-5 fw-bold">Loading Yalla<span class="animate-pulse">...</span></p>
        </div>
    </div>

    <!-- Maintenance Notification for Whitelisted IPs -->
    {% if g.is_whitelisted %}
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11; min-width: 300px;">
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #fff3cd; border: 1px solid #ffc107; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px;">
            <div class="toast-header" style="background-color: #ffc107; border-bottom: 1px solid #ffb300;">
                <span style="color: #000; font-weight: 600;">‚ö†Ô∏è Maintenance Mode Active</span>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" style="color: #333;">
                üîß Website is under maintenance. You can access it because your IP is whitelisted.
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg sticky-top" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">üçΩÔ∏è Yalla</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('restaurants') }}">Restaurants</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('leaderboard') }}">Leaderboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('news') }}">News</a></li>
                    {% if current_user.is_authenticated %}
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('add_restaurant') }}">+ Add</a></li>
                    {% if current_user.is_admin %}<li class="nav-item"><a class="nav-link text-warning fw-bold"
                            href="{{ url_for('admin_dashboard') }}">Admin</a></li>{% endif %}
                    {% endif %}
                </ul>
                <form class="d-flex me-3" action="{{ url_for('search') }}" method="GET">
                    <input class="form-control rounded-pill" type="search" name="q" placeholder="Search...">
                    <button class="btn btn-primary ms-2" type="submit">Go</button>
                </form>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button type="button" class="btn btn-link btn-dark-mode" id="darkModeToggle"
                            title="Toggle dark mode" style="text-decoration: none; padding: 0.5rem 0.75rem;">
                            <span id="darkModeIcon">üåô</span>
                        </button>
                    </li>
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                            data-bs-toggle="dropdown">
                            üë§ {{ current_user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item"
                                    href="{{ url_for('profile', user_id=current_user.id) }}">Profile</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}">Login</a></li>
                    <li class="nav-item"><a class="btn btn-primary btn-sm" href="{{ url_for('register') }}">Sign Up</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="container mt-3">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show animate-slide-down" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Content -->
    {% block content %}{% endblock %}

    <!-- Footer -->
    <footer class="mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <h5>üçΩÔ∏è Yalla</h5>
                    <p>Discover Jeddah's hidden culinary gems and support local businesses.</p>
                </div>
                <div class="col-md-4 mb-4">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="{{ url_for('index') }}">Home</a></li>
                        <li><a href="{{ url_for('restaurants') }}">Restaurants</a></li>
                        <li><a href="{{ url_for('add_restaurant') }}">Add Restaurant</a></li>
                    </ul>
                </div>
                <div class="col-md-4 mb-4">
                    <h5>Community</h5>
                    <p>Join our growing community of food lovers in Jeddah!</p>
                </div>
            </div>
            <hr class="border-secondary">
            <div class="text-center py-3">
                <p class="mb-0">&copy; 2024 Yalla. All rights reserved. üåü</p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap & Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>

    <script>
        // Dark Mode Management
        document.addEventListener('DOMContentLoaded', function () {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const darkModeIcon = document.getElementById('darkModeIcon');
            const appBody = document.getElementById('appBody');
            const isAuthenticated = {% if current_user.is_authenticated %}true{% else %}false{% endif %};
        const isDarkMode = {% if current_user.dark_mode %}true{% else %} false{% endif %};

        // Initialize dark mode on load
        function initDarkMode() {
            let shouldBeDark = false;

            if (isAuthenticated) {
                // Use database preference for authenticated users
                shouldBeDark = isDarkMode;
            } else {
                // Use localStorage for non-authenticated users
                const saved = localStorage.getItem('darkMode');
                shouldBeDark = saved === 'true';
            }

            if (shouldBeDark) {
                appBody.classList.add('dark-mode');
                if (darkModeIcon) darkModeIcon.textContent = '‚òÄÔ∏è';
            }
        }

        initDarkMode();

        // Show notification function
        function showNotification(message, type = 'info') {
            const container = document.querySelector('.container');
            if (!container) return;

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show animate-slide-down`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

            const firstContainer = document.querySelector('.container');
            if (firstContainer && firstContainer.parentNode) {
                firstContainer.parentNode.insertBefore(alertDiv, firstContainer.nextSibling);
                setTimeout(() => {
                    alertDiv.style.opacity = '0';
                    setTimeout(() => alertDiv.remove(), 300);
                }, 4000);
            }
        }

        // Toggle dark mode button click handler
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                // Toggle UI immediately
                appBody.classList.toggle('dark-mode');
                const isDarkNow = appBody.classList.contains('dark-mode');

                if (darkModeIcon) {
                    darkModeIcon.textContent = isDarkNow ? '‚òÄÔ∏è' : 'üåô';
                }

                if (isAuthenticated) {
                    const form = document.getElementById("darkModeForm");
                    const hiddenInput = document.getElementById("darkModeInput");

                    hiddenInput.value = isDarkNow;

                    // Submit form *without* reloading page
                    fetch(form.action, {
                        method: "POST",
                        body: new FormData(form)
                    })
                        .then(async response => {
                            const text = await response.text();

                            try {
                                return JSON.parse(text);
                            } catch (e) {
                                console.error("Server did NOT return JSON:", text);
                                throw new Error("Invalid JSON from server");
                            }
                        })
                        .then(data => {
                            console.log("Dark mode saved:", data);
                        })
                        .catch(err => console.error("Save error:", err));
                } else {
                    localStorage.setItem('darkMode', isDarkNow.toString());
                }
            });
        }

        // Hide loading screen on load
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
            loadingScreen.classList.add('hidden');
        }

        // Initialize all tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        Array.from(tooltipTriggerList).forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Initialize popovers
        const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
        Array.from(popoverTriggerList).forEach(function (popoverTriggerEl) {
            new bootstrap.Popover(popoverTriggerEl);
        });
    });

        // Navbar shadow on scroll
        window.addEventListener('scroll', function () {
            const navbar = document.getElementById('mainNav');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>